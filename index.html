<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Joker Bet â€“ Cotes Live</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>ğŸ“Š Cotes en direct</h1>
<div id="cotes"></div>
<h2>ğŸ† Top Parieurs</h2>
<div id="top"></div>

<audio id="tickSound" preload="auto"></audio>

<script src="config.js"></script>
<script>
let lastCotes = [];
let firstLoad = true;

async function loadCotes(){

  const query = `
    SELECT A, E, H
    WHERE A IS NOT NULL
    LIMIT 3
  `;

  const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?sheet=${CONFIG.SHEET_NAME}&tq=${encodeURIComponent(query)}`;

  const res = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text.substr(47).slice(0, -2));
  const rows = json.table.rows;

  const labels = ["Victoire A", "Nul", "Victoire B"];
  let html = "";

  rows.forEach((r, i) => {

    const cote = r.c[1]?.v;
    const status = r.c[2]?.v;

    if (status === "FERME") return;

    const coteAffiche = cote ? cote.toFixed(2) : "â€”";

    let anim = "";
    let arrow = "";

    if (!firstLoad && lastCotes[i] !== undefined && cote !== undefined) {
      const diff = cote - lastCotes[i];

      if (diff > 0) { anim = "cote-up"; arrow = "â–²"; }
      if (diff < 0) { anim = "cote-down"; arrow = "â–¼"; }

      if (Math.abs(diff) >= 0.5) {
        anim += " cote-big";
      }
    }

    html += `
      <div class="card">
        <h3>${labels[i]}</h3>
        <p>
          Cote :
          <span class="cote ${anim}">
            ${coteAffiche}
            <span class="arrow">${arrow}</span>
          </span>
        </p>
      </div>
    `;

    lastCotes[i] = cote;
  });

  document.getElementById("cotes").innerHTML = html;
  firstLoad = false;
}

loadCotes();
setInterval(loadCotes, 5000);
async function loadTop(){

  const query = `
    SELECT B, SUM(E)
    GROUP BY B
    ORDER BY SUM(E) DESC
    LIMIT 5
  `;

  const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?sheet=PARIS&tq=${encodeURIComponent(query)}`;

  const res = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text.substr(47).slice(0, -2));
  const rows = json.table.rows;

  let html = "";

  rows.forEach((r,i)=>{
    html += `
      <div class="card">
        ğŸ… #${i+1} <b>${r.c[0].v}</b><br>
        Total misÃ© : ${r.c[1].v}$
      </div>
    `;
  });

  document.getElementById("top").innerHTML = html;
}

loadTop();
setInterval(loadTop, 10000);

  
</script>

</body>
</html>
