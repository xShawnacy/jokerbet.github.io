<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JOKERBET — Cotes Live</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; background:#0b0f14; color:#e8eef6; }
    h1 { margin: 0 0 6px; }
    .muted { color:#9fb0c3; font-size: 12px; margin-bottom: 14px; }
    .card { background:#111826; border:1px solid #223047; border-radius:12px; padding:14px; }
    table { width:100%; border-collapse: collapse; overflow:hidden; border-radius:10px; }
    th, td { border-bottom: 1px solid #223047; padding: 10px; text-align: left; }
    th { color:#9fb0c3; font-weight:600; font-size: 12px; text-transform: uppercase; letter-spacing:.04em; }
    tr:hover td { background:#0f1624; }
    .right { text-align:right; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #223047; }
    .ok { border-color:#1f6f3b; color:#a7f3c3; }
    .warn { border-color:#7a3b1f; color:#ffd2b8; }
    .err { border-color:#7a1f2b; color:#ffb8c1; }
    .controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 10px 0 14px; }
    input { background:#0b1220; color:#e8eef6; border:1px solid #223047; border-radius:10px; padding:8px 10px; }
    button { background:#1d4ed8; border:none; color:white; padding:8px 12px; border-radius:10px; cursor:pointer; }
    button:active { transform: translateY(1px); }
    .small { font-size:12px; }
  </style>
</head>
<body>
  <h1>JOKERBET — Cotes Live</h1>
  <div class="muted" id="meta">Chargement…</div>

  <div class="controls">
    <label class="small">Filtre:
      <input id="filter" placeholder="ex: Victoire, Nul, Event…" />
    </label>
    <label class="small">Refresh (sec):
      <input id="refresh" type="number" min="5" value="15" style="width:80px" />
    </label>
    <button id="btnReload">Rafraîchir</button>
  </div>

  <div class="card">
    <table>
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAbDtfK4pEAlfBlo6JrSA5dcGV35C1oEF37DUUF-oP6n5dk81yGmNuPnKYxhBGsg/pub?gid=111010267&single=true&output=csv";

let timer = null;
let lastData = [];

document.getElementById("btnReload").addEventListener("click", load);
document.getElementById("filter").addEventListener("input", render);
document.getElementById("refresh").addEventListener("change", setupRefresh);

function parseCSV(text) {
  // parse simple avec support des guillemets
  const rows = [];
  let row = [], cell = "", inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i], next = text[i+1];

    if (c === '"' ) {
      if (inQuotes && next === '"') { cell += '"'; i++; }
      else { inQuotes = !inQuotes; }
      continue;
    }
    if (!inQuotes && (c === ',' || c === '\n' || c === '\r')) {
      if (c === '\r' && next === '\n') { /* windows newline */ }
      row.push(cell); cell = "";
      if (c === '\n') { rows.push(row); row = []; }
      continue;
    }
    cell += c;
  }
  // last cell
  if (cell.length || row.length) { row.push(cell); rows.push(row); }
  return rows.filter(r => r.some(v => (v ?? "").trim() !== ""));
}

function normalizeHeader(h) {
  return String(h || "").trim();
}

function looksNumber(v) {
  const s = String(v ?? "").trim().replace(/\s/g,'').replace(',', '.');
  return s !== "" && !isNaN(Number(s));
}

function fmt(v) {
  if (looksNumber(v)) {
    const n = Number(String(v).trim().replace(/\s/g,'').replace(',', '.'));
    return n.toLocaleString("fr-FR", { maximumFractionDigits: 2 });
  }
  return String(v ?? "").trim();
}

async function load() {
  const url = CSV_URL + "&_ts=" + Date.now(); // anti-cache
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error("HTTP " + res.status);
  const csv = await res.text();
  const raw = parseCSV(csv);

  const headers = raw[0].map(normalizeHeader);
  const data = raw.slice(1)
    .filter(r => r.some(x => String(x ?? "").trim() !== ""))
    .map(r => Object.fromEntries(headers.map((h, i) => [h, (r[i] ?? "").trim()])));

  lastData = { headers, data, updatedAt: new Date() };
  render();
}

function render() {
  const { headers, data, updatedAt } = lastData;
  if (!headers) return;

  const q = document.getElementById("filter").value.trim().toLowerCase();

  const filtered = !q ? data : data.filter(obj =>
    headers.some(h => String(obj[h] ?? "").toLowerCase().includes(q))
  );

  // Header table
  const thead = document.getElementById("thead");
  thead.innerHTML = "<tr>" + headers.map(h => `<th>${escapeHtml(h)}</th>`).join("") + "</tr>";

  // Body
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  for (const obj of filtered) {
    const tr = document.createElement("tr");
    tr.innerHTML = headers.map(h => {
      const v = obj[h];
      const cls = looksNumber(v) ? "right" : "";
      return `<td class="${cls}">${escapeHtml(fmt(v))}</td>`;
    }).join("");
    tbody.appendChild(tr);
  }

  document.getElementById("meta").textContent =
    `Mis à jour: ${updatedAt.toLocaleString("fr-FR")} — lignes: ${filtered.length}/${data.length}`;
}

function setupRefresh() {
  if (timer) clearInterval(timer);
  const sec = Math.max(5, Number(document.getElementById("refresh").value || 15));
  timer = setInterval(() => load().catch(err => {
    console.error(err);
    document.getElementById("meta").textContent = "Erreur de chargement: " + err.message;
  }), sec * 1000);
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );
}

load().catch(err => {
  console.error(err);
  document.getElementById("meta").textContent = "Erreur de chargement: " + err.message;
});
setupRefresh();
</script>
</body>
</html>
